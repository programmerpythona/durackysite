<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Wolf & Eggs - Premium Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0; 
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        body {
            font-family: 'Press Start 2P', monospace;
            background: linear-gradient(180deg, #87CEEB 0%, #98D8C8 50%, #F7DC6F 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* Разрешаем вертикальную прокрутку в узком предпросмотре */
            overflow: auto;
            position: relative;
        }

        /* Анимированные облака */
        .cloud {
            position: absolute;
            background: white;
            border-radius: 100px;
            opacity: 0.7;
            animation: float 20s infinite;
        }

        .cloud::before {
            content: '';
            position: absolute;
            background: white;
            border-radius: 100px;
        }

        .cloud1 {
            width: 100px;
            height: 40px;
            top: 10%;
            left: -100px;
            animation-duration: 25s;
        }

        .cloud1::before {
            width: 50px;
            height: 50px;
            top: -25px;
            left: 20px;
        }

        .cloud2 {
            width: 80px;
            height: 35px;
            top: 25%;
            left: -80px;
            animation-duration: 30s;
            animation-delay: 5s;
        }

        @keyframes float {
            from { transform: translateX(0); }
            to { transform: translateX(calc(100vw + 200px)); }
        }

        #gameContainer {
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            border-radius: 25px;
            padding: 15px;
            box-shadow: 
                0 20px 60px rgba(0,0,0,0.5),
                inset 0 -5px 10px rgba(0,0,0,0.3),
                inset 0 5px 10px rgba(255,255,255,0.1);
            max-width: 420px;
            width: 100%;
            border: 4px solid #333;
            position: relative;
            z-index: 10;
            /* ВАЖНО: вписываем в экран по высоте */
            max-height: calc(100vh - 16px);
            display: flex;
            flex-direction: column;
            padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 10px);
        }

        #gameScreen {
            background: linear-gradient(180deg, #8BC34A 0%, #9CCC65 100%);
            border-radius: 15px;
            position: relative;
            height: 550px;
            border: 3px solid #558B2F;
            box-shadow: 
                inset 0 0 30px rgba(0,0,0,0.2),
                inset 0 0 100px rgba(139,195,74,0.3);
            overflow: hidden;
        }

        /* HUD верхняя панель */
        #hud {
            background: linear-gradient(180deg, rgba(0,0,0,0.7), rgba(0,0,0,0.5));
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
            backdrop-filter: blur(5px);
        }

        #score {
            color: #FFD700;
            font-size: 14px;
            text-shadow: 2px 2px 0 #000, 0 0 10px #FFD700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #timeLeft {
            color: #fff;
            font-size: 12px;
            text-shadow: 2px 2px 0 #000;
        }

        #combo {
            color: #FF6B6B;
            font-size: 12px;
            text-shadow: 2px 2px 0 #000;
            animation: pulse 0.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        #lives {
            display: flex;
            gap: 5px;
            align-items: center;
        }

        .heart {
            font-size: 20px;
            animation: heartbeat 1s infinite;
            filter: drop-shadow(0 0 3px rgba(255,0,0,0.5));
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        #gameArea {
            position: relative;
            height: 420px;
            background: 
                linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 20%),
                url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="%23689F38"/><circle cx="50" cy="50" r="40" fill="%2377A846" opacity="0.3"/></svg>');
            background-size: 100px 100px;
            overflow: hidden;
        }

        /* Куриные гнезда */
        .nest {
            position: absolute;
            width: 60px;
            height: 40px;
            background: linear-gradient(180deg, #8D6E63, #6D4C41);
            border-radius: 50% 50% 45% 45%;
            box-shadow: 
                inset 0 5px 10px rgba(0,0,0,0.3),
                0 5px 10px rgba(0,0,0,0.2);
        }

        .nest::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                90deg,
                #5D4037,
                #5D4037 2px,
                #6D4C41 2px,
                #6D4C41 4px
            );
            border-radius: inherit;
            opacity: 0.5;
        }

        .nest.left-top { top: 60px; left: 30px; }
        .nest.left-bottom { top: 180px; left: 30px; }
        .nest.right-top { top: 60px; right: 30px; }
        .nest.right-bottom { top: 180px; right: 30px; }

        /* Куры с анимацией */
        .chicken {
            position: absolute;
            font-size: 45px;
            transition: all 0.3s;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
            animation: chickenBob 2s ease-in-out infinite;
        }

        @keyframes chickenBob {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-5px) rotate(5deg); }
        }

        .chicken.laying {
            animation: layEgg 0.5s ease-out;
        }

        @keyframes layEgg {
            0% { transform: scale(1) rotate(0); }
            50% { transform: scale(1.2) rotate(-10deg); }
            100% { transform: scale(1) rotate(0); }
        }

        .chicken.left-top { top: 50px; left: 25px; }
        .chicken.left-bottom { top: 170px; left: 25px; }
        .chicken.right-top { top: 50px; right: 25px; }
        .chicken.right-bottom { top: 170px; right: 25px; }

        /* Яйца разных типов */
        .egg {
            position: absolute;
            font-size: 30px;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
            z-index: 10;
            /* падение управляем JS, вращение - CSS */
            animation: rotate 2s linear infinite;
        }

        .egg.golden {
            filter: drop-shadow(0 0 10px #FFD700);
            animation: rotate 1s linear infinite, glow 0.5s ease-in-out infinite;
        }

        .egg.bomb {
            filter: drop-shadow(0 0 10px #FF0000);
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 10px #FFD700); }
            50% { filter: drop-shadow(0 0 20px #FFD700) brightness(1.2); }
        }

        /* Волк с улучшенной анимацией */
        #wolf {
            position: absolute;
            bottom: 30px;
            font-size: 60px;
            transition: all 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 20;
            filter: drop-shadow(3px 3px 5px rgba(0,0,0,0.4));
        }

        #wolf.moving {
            animation: run 0.3s ease-out;
        }

        @keyframes run {
            0%, 100% { transform: rotate(0deg) scale(1); }
            25% { transform: rotate(-10deg) scale(1.1); }
            75% { transform: rotate(10deg) scale(1.1); }
        }

        #basket {
            position: absolute;
            bottom: 25px;
            font-size: 40px;
            transition: all 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 19;
            filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));
        }

        #basket.catch {
            animation: basketCatch 0.3s ease-out;
        }

        @keyframes basketCatch {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.3) rotate(-10deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        /* Эффекты */
        .particle {
            position: absolute;
            pointer-events: none;
            animation: particle 1s ease-out forwards;
        }

        @keyframes particle {
            0% {
                transform: translate(0, 0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translate(var(--dx), var(--dy)) scale(0);
                opacity: 0;
            }
        }

        .broken-egg {
            position: absolute;
            font-size: 35px;
            animation: splat 0.5s ease-out forwards;
        }

        @keyframes splat {
            0% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.5) rotate(180deg); }
            100% { transform: scale(2) rotate(360deg); opacity: 0; }
        }

        .catch-effect {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            animation: catchPoints 1s ease-out forwards;
            z-index: 30;
            text-shadow: 2px 2px 0 #000;
        }

        @keyframes catchPoints {
            0% { 
                transform: scale(1) translateY(0);
                opacity: 1;
            }
            100% { 
                transform: scale(1.5) translateY(-50px);
                opacity: 0;
            }
        }

        /* Power-ups */
        .powerup {
            position: absolute;
            font-size: 35px;
            z-index: 15;
            filter: drop-shadow(0 0 15px rgba(255,255,255,0.8));
            animation: rotate 2s linear infinite;
        }

        /* Статистика и достижения */
        #stats {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 10px;
            display: none;
            backdrop-filter: blur(5px);
        }

        #achievement {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(145deg, #FFD700, #FFA000);
            color: #000;
            padding: 20px;
            border-radius: 15px;
            font-size: 12px;
            text-align: center;
            display: none;
            z-index: 100;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: achievementPop 0.5s ease-out;
        }

        @keyframes achievementPop {
            0% { transform: translate(-50%, -50%) scale(0) rotate(180deg); }
            50% { transform: translate(-50%, -50%) scale(1.2) rotate(360deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(360deg); }
        }

        /* Контролы */
        #controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
            padding: 8px 5px calc(env(safe-area-inset-bottom, 0px) + 8px);
            position: sticky;
            bottom: 0;
            z-index: 60;
            background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,0.25));
            backdrop-filter: blur(4px);
        }

        .control-btn {
            padding: 12px;
            font-size: 24px;
            background: linear-gradient(145deg, #616161, #424242);
            border: none;
            border-radius: 12px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 
                0 5px 0 #212121,
                0 8px 10px rgba(0,0,0,0.3);
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }

        .control-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .control-btn:active::before {
            width: 300px;
            height: 300px;
        }

        .control-btn:active {
            transform: translateY(3px);
            box-shadow: 
                0 2px 0 #212121,
                0 4px 5px rgba(0,0,0,0.3);
        }

        .control-btn.special {
            background: linear-gradient(145deg, #FF6B6B, #FF5252);
            box-shadow: 
                0 5px 0 #C62828,
                0 8px 10px rgba(0,0,0,0.3);
            grid-column: span 2;
        }

        /* Меню и экраны */
        #startScreen, #gameOver, #pauseMenu {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, rgba(0,0,0,0.95), rgba(0,0,0,0.85));
            backdrop-filter: blur(10px);
            color: #fff;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 15px;
            z-index: 100;
            padding: 20px;
        }

        #startScreen h1 {
            font-size: 24px;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #FFD700, #FFA000);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255,215,0,0.5);
            animation: titleGlow 2s ease-in-out infinite;
        }

        @keyframes titleGlow {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.2); }
        }

        .menu-info {
            text-align: center;
            margin: 20px 0;
            font-size: 10px;
            line-height: 20px;
            color: #aaa;
        }

        .menu-btn {
            margin: 10px;
            padding: 15px 30px;
            font-size: 12px;
            background: linear-gradient(145deg, #4CAF50, #388E3C);
            border: none;
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Press Start 2P', monospace;
            box-shadow: 
                0 5px 0 #2E7D32,
                0 8px 15px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden;
        }

        .menu-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 7px 0 #2E7D32,
                0 10px 20px rgba(0,0,0,0.4);
        }

        .menu-btn:active {
            transform: translateY(2px);
            box-shadow: 
                0 2px 0 #2E7D32,
                0 4px 10px rgba(0,0,0,0.3);
        }

        .menu-btn:active::after {
            width: 300px;
            height: 300px;
        }

        .menu-btn.secondary {
            background: linear-gradient(145deg, #FF9800, #F57C00);
            box-shadow: 
                0 5px 0 #E65100,
                0 8px 15px rgba(0,0,0,0.3);
        }

        /* Звуковые индикаторы */
        #soundToggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.5);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            z-index: 50;
            transition: all 0.3s;
        }

        #soundToggle:hover {
            background: rgba(0,0,0,0.7);
            transform: scale(1.1);
        }

        /* Плавающая кнопка скрытия/показа контролов */
        .overlay-btn {
            position: absolute;
            right: 8px;
            bottom: 8px;
            z-index: 120;
            border: none;
            border-radius: 999px;
            padding: 8px 10px;
            font-size: 12px;
            background: rgba(0,0,0,0.55);
            color: #fff;
            backdrop-filter: blur(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        /* Индикаторы прогресса */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            border-radius: 4px;
            transition: width 0.3s;
            box-shadow: 0 0 10px rgba(76,175,80,0.5);
        }

        /* Адаптивность */
        @media (max-height: 650px) {
            #gameScreen { height: 450px; }
            #gameArea { height: 350px; }
            .control-btn { padding: 10px; font-size: 20px; }
            #hud { padding: 8px; }
            #score { font-size: 12px; }
        }
        /* Ещё компактнее при очень низком экране */
        @media (max-height: 560px) {
            #gameScreen { height: 400px; }
            #gameArea { height: 300px; }
            .control-btn { padding: 8px; font-size: 18px; }
        }

        /* Режимы игры */
        .game-mode-selector {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .mode-btn {
            padding: 10px;
            background: rgba(255,255,255,0.1);
            border: 2px solid #FFD700;
            border-radius: 10px;
            color: #FFD700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 10px;
        }

        .mode-btn:hover {
            background: rgba(255,215,0,0.2);
            transform: scale(1.05);
        }

        .mode-btn.active {
            background: #FFD700;
            color: #000;
        }

        /* Таблица лидеров */
        #leaderboard {
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 5px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 5px;
            font-size: 10px;
        }

        .leaderboard-entry.gold { color: #FFD700; }
        .leaderboard-entry.silver { color: #C0C0C0; }
        .leaderboard-entry.bronze { color: #CD7F32; }
    </style>
</head>
<body>
    <div class="cloud cloud1"></div>
    <div class="cloud cloud2"></div>
    
    <div id="gameContainer">
        <button id="soundToggle" title="Звук">🔊</button>
        
        <div id="gameScreen">
            <div id="hud">
                <div id="score">
                    <span>СЧЁТ: <span id="scoreValue">0</span></span>
                    <span id="combo" style="display: none;">COMBO x<span id="comboValue">1</span></span>
                </div>
                <div id="timeLeft"></div>
                <div id="lives"></div>
            </div>
            
            <div id="gameArea">
                <!-- Гнёзда -->
                <div class="nest left-top"></div>
                <div class="nest left-bottom"></div>
                <div class="nest right-top"></div>
                <div class="nest right-bottom"></div>
                
                <!-- Куры -->
                <div class="chicken left-top">🐔</div>
                <div class="chicken left-bottom">🐓</div>
                <div class="chicken right-top">🐔</div>
                <div class="chicken right-bottom">🐓</div>
                
                <!-- Волк и корзина -->
                <div id="wolf">🐺</div>
                <div id="basket">🧺</div>
                
                <!-- Экраны -->
                <div id="startScreen">
                    <h1>🐺 WOLF & EGGS 🥚</h1>
                    <div class="menu-info">
                        <p>PREMIUM EDITION</p>
                        <p>━━━━━━━━━━━━━━━</p>
                        <p>🥚 Обычное яйцо = 1 очко</p>
                        <p>🌟 Золотое яйцо = 5 очков</p>
                        <p>💣 Бомба = -1 жизнь при ловле</p>
                        <p>⚡ Power-ups дают бонусы</p>
                        <p>━━━━━━━━━━━━━━━</p>
                    </div>
                    
                    <div class="game-mode-selector">
                        <button class="mode-btn active" data-mode="classic">КЛАССИКА</button>
                        <button class="mode-btn" data-mode="survival">ВЫЖИВАНИЕ</button>
                        <button class="mode-btn" data-mode="time">НА ВРЕМЯ</button>
                    </div>
                    
                    <button class="menu-btn" id="startBtn">НАЧАТЬ ИГРУ</button>
                    <button class="menu-btn secondary" id="leaderboardBtn">РЕКОРДЫ</button>
                    
                    <div id="leaderboard" style="display:none;"></div>
                    
                    <div class="menu-info">
                        <p>Лучший счёт: <span id="bestScore">0</span></p>
                        <p>Всего яиц: <span id="totalEggs">0</span></p>
                    </div>
                </div>
                
                <div id="gameOver" style="display: none;">
                    <h1>ИГРА ОКОНЧЕНА!</h1>
                    <div class="menu-info">
                        <p style="font-size: 16px; color: #FFD700;">Счёт: <span id="finalScore">0</span></p>
                        <p>Рекорд: <span id="finalBest">0</span></p>
                        <p>Яиц поймано: <span id="eggsCount">0</span></p>
                        <p>Макс. комбо: <span id="maxCombo">0</span></p>
                    </div>
                    <div id="newRecord" style="display: none; color: #FFD700; font-size: 14px; margin: 10px;">
                        🏆 НОВЫЙ РЕКОРД! 🏆
                    </div>
                    <button class="menu-btn" id="restartBtn">ИГРАТЬ СНОВА</button>
                    <button class="menu-btn secondary" id="menuBtn">В МЕНЮ</button>
                </div>
                
                <div id="pauseMenu" style="display: none;">
                    <h1>ПАУЗА</h1>
                    <button class="menu-btn" id="resumeBtn">ПРОДОЛЖИТЬ</button>
                    <button class="menu-btn secondary" id="exitBtn">ВЫХОД</button>
                </div>
                
                <div id="achievement" style="display: none;">
                    <div id="achievementIcon">🏆</div>
                    <div id="achievementText">Достижение!</div>
                </div>
                
                <div id="stats">
                    <div>FPS: <span id="fps">60</span></div>
                    <div>Уровень: <span id="level">1</span></div>
                </div>
            </div>

            <!-- Плавающая кнопка - скрыть/показать блок управления -->
            <button id="controlsToggle" class="overlay-btn" title="Скрыть/показать кнопки управления">🎮 Кнопки</button>

            <div id="controls">
                <button class="control-btn" data-pos="left-top">↖️</button>
                <button class="control-btn" data-pos="right-top">↗️</button>
                <button class="control-btn" data-pos="left-bottom">↙️</button>
                <button class="control-btn" data-pos="right-bottom">↘️</button>
                <button class="control-btn special" id="pauseBtn">⏸️ ПАУЗА</button>
            </div>
        </div>
    </div>

    <script>
// Утилиты
const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
const rand = (a, b) => a + Math.random() * (b - a);
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

// Звуковая система
class SoundSystem {
  constructor() { this.enabled = true; this.context = null; this.masterGain = null; this.sounds = {}; this.init(); }
  init() {
    const startAudio = () => {
      if (!this.context) {
        this.context = new (window.AudioContext || window.webkitAudioContext)();
        this.masterGain = this.context.createGain();
        this.masterGain.gain.value = 0.15;
        this.masterGain.connect(this.context.destination);
        this.createSounds();
      }
      document.removeEventListener('click', startAudio);
      document.removeEventListener('touchstart', startAudio);
    };
    document.addEventListener('click', startAudio, { once: true });
    document.addEventListener('touchstart', startAudio, { once: true });
  }
  playTone(freq, duration = 0.1, type = 'square') {
    if (!this.enabled || !this.context) return;
    const o = this.context.createOscillator();
    const g = this.context.createGain();
    o.type = type; o.frequency.value = freq;
    o.connect(g); g.connect(this.masterGain);
    const now = this.context.currentTime;
    g.gain.setValueAtTime(0, now);
    g.gain.linearRampToValueAtTime(1, now + 0.01);
    g.gain.exponentialRampToValueAtTime(0.001, now + duration);
    o.start(now); o.stop(now + duration + 0.02);
  }
  createSounds() {
    this.sounds.catch = () => this.playTone(800, 0.08, 'square');
    this.sounds.miss = () => this.playTone(220, 0.25, 'sawtooth');
    this.sounds.golden = () => { this.playTone(1000, 0.09, 'square'); setTimeout(()=>this.playTone(1200, 0.09, 'square'), 90); };
    this.sounds.powerup = () => { for (let i=0;i<5;i++) setTimeout(()=>this.playTone(400 + i*120, 0.05, 'square'), i*50); };
    this.sounds.achievement = () => { [523,659,784,1047].forEach((f,i)=> setTimeout(()=>this.playTone(f,0.18,'square'), i*150)); };
    this.sounds.gameOver = () => { [440,392,330,262].forEach((f,i)=> setTimeout(()=>this.playTone(f,0.22,'triangle'), i*180)); };
    this.sounds.bomb = () => { this.playTone(120,0.2,'sawtooth'); setTimeout(()=>this.playTone(80,0.25,'sawtooth'),90); };
    this.sounds.click = () => this.playTone(520,0.05,'square');
  }
}
const sound = new SoundSystem();

// DOM
const gameArea = document.getElementById('gameArea');
const wolfEl = document.getElementById('wolf');
const basketEl = document.getElementById('basket');
const scoreValue = document.getElementById('scoreValue');
const comboWrap = document.getElementById('combo');
const comboValue = document.getElementById('comboValue');
const livesWrap = document.getElementById('lives');
const fpsEl = document.getElementById('fps');
const levelEl = document.getElementById('level');
const bestScoreEl = document.getElementById('bestScore');
const totalEggsEl = document.getElementById('totalEggs');
const startScreen = document.getElementById('startScreen');
const pauseMenu = document.getElementById('pauseMenu');
const gameOver = document.getElementById('gameOver');
const finalScore = document.getElementById('finalScore');
const finalBest = document.getElementById('finalBest');
const eggsCount = document.getElementById('eggsCount');
const maxComboEl = document.getElementById('maxCombo');
const newRecord = document.getElementById('newRecord');
const achievement = document.getElementById('achievement');
const achievementText = document.getElementById('achievementText');
const achievementIcon = document.getElementById('achievementIcon');
const timeLeftEl = document.getElementById('timeLeft');
const leaderboardBox = document.getElementById('leaderboard');

// Доп. элементы для адаптации высоты
const gameContainer = document.getElementById('gameContainer');
const gameScreen = document.getElementById('gameScreen');
const controls = document.getElementById('controls');
const hudEl = document.getElementById('hud');
const controlsToggleBtn = document.getElementById('controlsToggle');

const nests = {
  'left-top': { nest: document.querySelector('.nest.left-top'), chicken: document.querySelector('.chicken.left-top') },
  'left-bottom': { nest: document.querySelector('.nest.left-bottom'), chicken: document.querySelector('.chicken.left-bottom') },
  'right-top': { nest: document.querySelector('.nest.right-top'), chicken: document.querySelector('.chicken.right-top') },
  'right-bottom': { nest: document.querySelector('.nest.right-bottom'), chicken: document.querySelector('.chicken.right-bottom') }
};
const POSITIONS = ['left-top','right-top','left-bottom','right-bottom'];

// Геометрия
let layout = {};
function computeLayout() {
  const areaRect = gameArea.getBoundingClientRect();
  layout.areaLeft = areaRect.left; layout.areaTop = areaRect.top;
  layout.areaWidth = areaRect.width; layout.areaHeight = areaRect.height;
  layout.catchY = layout.areaHeight - 70;
  for (const key of POSITIONS) {
    const rect = nests[key].nest.getBoundingClientRect();
    const x = rect.left - layout.areaLeft + rect.width/2;
    layout[key] = { spawnX: x, spawnY: rect.top - layout.areaTop + rect.height*0.2, catchX: x, catchY: layout.catchY };
  }
  placeWolf(currentPos);
}
// Адаптивные высоты — делаем так, чтобы кнопки всегда помещались
function fitHeights(){
  const vh = window.innerHeight || document.documentElement.clientHeight;
  const cs = getComputedStyle(gameContainer);
  const padV = parseFloat(cs.paddingTop) + parseFloat(cs.paddingBottom);
  const bTop = parseFloat(cs.borderTopWidth) || 0;
  const bBot = parseFloat(cs.borderBottomWidth) || 0;
  const extras = padV + bTop + bBot;
  const controlsH = controls ? controls.offsetHeight : 0;
  // Рассчитываем высоту экрана игры так, чтобы блок кнопок был полностью виден
  const maxScreen = Math.floor(vh - controlsH - extras - 24);
  const screenH = Math.max(380, Math.min(560, maxScreen));
  gameScreen.style.height = screenH + 'px';
  const hudH = hudEl ? hudEl.offsetHeight : 0;
  const areaH = Math.max(300, screenH - hudH - 20);
  gameArea.style.height = areaH + 'px';
  // после изменения размеров пересчитываем геометрию
  computeLayout();
}
window.addEventListener('resize', fitHeights);

// Показ/скрытие блока с кнопками управления
let controlsVisible = true;
function toggleControlsVisibility(){
  controlsVisible = !controlsVisible;
  controls.style.display = controlsVisible ? 'grid' : 'none';
  controlsToggleBtn.textContent = controlsVisible ? '🎮 Кнопки' : '🎮 Показать';
  fitHeights();
}
controlsToggleBtn.addEventListener('click', toggleControlsVisibility);

// Хранилище
const LS = {
  best: () => +localStorage.getItem('wolfGame_bestScore') || 0,
  setBest: (v) => localStorage.setItem('wolfGame_bestScore', String(v)),
  totalEggs: () => +localStorage.getItem('wolfGame_totalEggs') || 0,
  setTotalEggs: (v) => localStorage.setItem('wolfGame_totalEggs', String(v)),
  leaderboard: () => JSON.parse(localStorage.getItem('wolfGame_leaderboard')||'[]'),
  setLeaderboard: (arr) => localStorage.setItem('wolfGame_leaderboard', JSON.stringify(arr.slice(0,10)))
};

// Состояние игры
let running = false;
let paused = false;
let mode = 'classic'; // classic | survival | time
let score = 0; let level = 1; let lives = 3;
let combo = 0, maxCombo = 0; let eggsCaught = 0;
let slowUntil = 0; let multiplierUntil = 0; // timestamps
const HAZARD_GAP_MS = 900; let hazardLockUntil = 0;
let timeLimit = 0; let timeStart = 0; // ms
let lastSpawn = 0; let spawnInterval = 1100; // ms
let eggSpeed = 140; // px/sec
let entities = [];
let currentPos = 'left-bottom';

const hasActiveEgg = () => entities.some(e => e.type === 'normal' || e.type === 'golden');
const hasActiveBomb = () => entities.some(e => e.type === 'bomb');

// Эффекты
function particleBurst(x, y, emoji='✨', count=10) {
  for (let i=0;i<count;i++) {
    const p = document.createElement('div');
    p.className = 'particle'; p.textContent = emoji;
    p.style.left = (x-8) + 'px'; p.style.top = (y-8) + 'px';
    p.style.setProperty('--dx', rand(-60,60)+'px');
    p.style.setProperty('--dy', rand(-80,-20)+'px');
    gameArea.appendChild(p); setTimeout(()=>p.remove(), 1000);
  }
}
function showCatchPoints(x,y,points) {
  const d = document.createElement('div');
  d.className = 'catch-effect'; d.textContent = `+${points}`;
  d.style.left = (x-10)+'px'; d.style.top = (y-10)+'px';
  gameArea.appendChild(d); setTimeout(()=>d.remove(), 1000);
}
function showBroken(x,y) {
  const b = document.createElement('div');
  b.className = 'broken-egg'; b.textContent = '💥';
  b.style.left = (x-10)+'px'; b.style.top = (y-10)+'px';
  gameArea.appendChild(b); setTimeout(()=>b.remove(), 500);
}
function showAchievement(text, icon='🏆') {
  achievementText.textContent = text; achievementIcon.textContent = icon;
  achievement.style.display = 'block'; sound.sounds.achievement();
  setTimeout(()=>achievement.style.display='none', 1800);
}

// HUD
function renderLives() {
  livesWrap.innerHTML = '';
  for (let i=0;i<lives;i++) { const s = document.createElement('span'); s.className='heart'; s.textContent='❤️'; livesWrap.appendChild(s); }
}
function renderScore() { scoreValue.textContent = score; }
function renderCombo() { if (combo>1) { comboWrap.style.display='inline-block'; comboValue.textContent = combo; } else comboWrap.style.display='none'; }
function updateStatsFPS(dt) { if (fpsEl) fpsEl.textContent = (1000/dt|0); if (levelEl) levelEl.textContent = level; }
function updateTimeLeft() {
  if (mode !== 'time') { timeLeftEl.textContent = ''; return; }
  const left = Math.max(0, timeLimit - (performance.now()-timeStart));
  timeLeftEl.textContent = '⏱ ' + Math.ceil(left/1000) + 's';
  if (left<=0) endGame();
}

// Позиции волка/корзины
function placeWolf(pos) {
  const L = layout[pos]; if (!L) return;
  const x = clamp(L.catchX - 18, 0, Math.max(0, layout.areaWidth - 36));
  const wolfLeft = clamp(x - 20, 0, Math.max(0, layout.areaWidth - 40));
  const basketLeft = clamp(x - 8, 0, Math.max(0, layout.areaWidth - 24));
  wolfEl.style.left = wolfLeft + 'px';
  basketEl.style.left = basketLeft + 'px';
  wolfEl.classList.add('moving');
  basketEl.classList.add('catch');
  setTimeout(()=>{
    wolfEl.classList.remove('moving');
    basketEl.classList.remove('catch');
  }, 220);
}

// Сущности
class Egg {
  constructor(type, posKey) {
    this.type = type; this.source = posKey;
    const L = layout[posKey]; this.x = L.spawnX; this.y = L.spawnY;
    this.el = document.createElement('div');
    if (type==='normal') this.el.textContent = '🥚';
    if (type==='golden') { this.el.textContent = '🥚'; this.el.classList.add('golden'); }
    if (type==='bomb') { this.el.textContent = '💣'; this.el.classList.add('bomb'); }
    if (type.startsWith('power:')) { this.el.className='powerup'; this.el.textContent = this.icon(); }
    this.el.classList.add('egg'); gameArea.appendChild(this.el); this.updateEl();
    nests[posKey].chicken.classList.add('laying'); setTimeout(()=>nests[posKey].chicken.classList.remove('laying'), 300);
  }
  icon(){ if (this.type==='power:shield') return '🛡️'; if (this.type==='power:slow') return '🐢'; if (this.type==='power:x2') return '✖️2'; return '⭐'; }
  remove(){ this.el.remove(); }
  updateEl(){ this.el.style.left = (this.x-12)+'px'; this.el.style.top = (this.y-12)+'px'; }
  step(dt){
    const now = performance.now();
    const slowFactor = now < slowUntil ? 0.6 : 1;
    const vy = eggSpeed * slowFactor;
    this.y += vy * (dt/1000); this.updateEl();
    const L = layout[this.source];
    // ловля
    if (this.y >= L.catchY - 8 && this.y <= L.catchY + 18) {
      if (currentPos === this.source) {
        if (this.type === 'bomb') {
          sound.sounds.bomb();
          lifeLoss(this.x, this.y, true);
          hazardLockUntil = now + HAZARD_GAP_MS; // окно безопасности
          combo = 0; renderCombo();
        } else if (this.type.startsWith('power:')) {
          applyPower(this.type, this.x, this.y); sound.sounds.powerup();
        } else {
          const base = this.type==='golden' ? 5 : 1;
          const mult = now < multiplierUntil ? 2 : 1;
          const pts = base * mult * (1 + Math.floor(combo/10));
          score += pts; eggsCaught++; combo++; maxCombo = Math.max(maxCombo, combo);
          renderScore(); renderCombo(); showCatchPoints(this.x, this.y, pts);
          particleBurst(this.x, this.y, this.type==='golden'?'✨':'⭐', 12);
          if (this.type==='golden') sound.sounds.golden(); else sound.sounds.catch();
        }
        this.remove(); return true;
      }
    }
    // пропуск
    if (this.y > layout.areaHeight - 5) {
      if (this.type === 'bomb') {
        particleBurst(this.x, this.y, '💥', 8); sound.sounds.miss();
        hazardLockUntil = now + HAZARD_GAP_MS;
      } else if (this.type.startsWith('power:')) {
        // просто исчезает
      } else {
        showBroken(this.x, layout.areaHeight - 10); sound.sounds.miss();
        lifeLoss(this.x, this.y, false); combo = 0; renderCombo();
      }
      this.remove(); return true;
    }
    return false;
  }
}

function lifeLoss(x,y,byBomb){
  lives -= 1; renderLives();
  if (lives <= 0) { endGame(); }
  else particleBurst(x,y, byBomb? '💣':'💔', 10);
}
function applyPower(type,x,y){
  const now = performance.now();
  if (type==='power:shield') { lives = Math.min(5, lives+1); renderLives(); particleBurst(x,y,'❤️',10); }
  if (type==='power:slow') { slowUntil = now + 5000; particleBurst(x,y,'🐢',10); }
  if (type==='power:x2') { multiplierUntil = now + 10000; particleBurst(x,y,'✖️',10); }
}

// Спавн
function spawnEntity() {
  const now = performance.now();
  if (hasActiveBomb() || now < hazardLockUntil) return; // окно безопасности
  const pos = POSITIONS[(Math.random()*4)|0];
  const r = Math.random(); let type = 'normal';
  const eggsActive = hasActiveEgg();
  if (!eggsActive) {
    if (r < 0.08) type = 'golden';
    else if (r < 0.16) type = 'bomb';
    else if (r > 0.92) { const p = Math.random(); type = p<0.34 ? 'power:shield' : (p<0.67 ? 'power:slow' : 'power:x2'); }
    else type = 'normal';
  } else {
    if (r < 0.08) type = 'golden';
    else if (r > 0.92) { const p = Math.random(); type = p<0.34 ? 'power:shield' : (p<0.67 ? 'power:slow' : 'power:x2'); }
    else type = 'normal';
  }
  const e = new Egg(type, pos); entities.push(e);
  if (type === 'bomb') hazardLockUntil = now + HAZARD_GAP_MS;
}

function levelUpIfNeeded(){
  const newLevel = 1 + Math.floor(eggsCaught/20);
  if (newLevel !== level) {
    level = newLevel; levelEl.textContent = level;
    eggSpeed = Math.min(260, 140 + (level-1)*16);
    spawnInterval = Math.max(520, 1100 - (level-1)*40);
    showAchievement('Уровень ' + level + '!', '📈');
  }
}

// Игровой цикл
let lastT = 0;
function tick(t) {
  if (!running) return;
  const dt = Math.min(50, t - lastT || 16); lastT = t;
  if (!paused) {
    if (!lastSpawn) lastSpawn = t;
    if (t - lastSpawn >= spawnInterval) { spawnEntity(); lastSpawn = t; }
    for (let i=entities.length-1;i>=0;i--) { if (entities[i].step(dt)) entities.splice(i,1); }
    updateTimeLeft(); levelUpIfNeeded();
  }
  updateStatsFPS(dt);
  requestAnimationFrame(tick);
}

// Управление
function setPos(pos){ currentPos = pos; placeWolf(pos); }
$$('#controls .control-btn[data-pos]').forEach(btn=>{ btn.addEventListener('click',()=>{ sound.sounds.click(); setPos(btn.dataset.pos); }); });
$('#pauseBtn').addEventListener('click', togglePause);
$('#resumeBtn').addEventListener('click', ()=>{ paused=false; pauseMenu.style.display='none'; });
$('#exitBtn').addEventListener('click', ()=>{ running=false; showMenu(); });
$('#startBtn').addEventListener('click', ()=>{ startGame(); });
$('#restartBtn').addEventListener('click', ()=>{ startGame(); });
$('#menuBtn').addEventListener('click', ()=>{ showMenu(); });
$('#leaderboardBtn').addEventListener('click', ()=>{ toggleLeaderboard(); });
$('#soundToggle').addEventListener('click', ()=>{ sound.enabled = !sound.enabled; $('#soundToggle').textContent = sound.enabled ? '🔊' : '🔇'; });

// Селектор режимов
$$('.mode-btn').forEach(b=> b.addEventListener('click', ()=>{
  $$('.mode-btn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); mode = b.dataset.mode;
}));

// Клавиатура (стрелки/WASD и NumPad 7/9/1/3)
let pressed = new Set();
function updatePosFromKeys(){
  const up = pressed.has('ArrowUp') || pressed.has('w') || pressed.has('W');
  const down = pressed.has('ArrowDown') || pressed.has('s') || pressed.has('S');
  const left = pressed.has('ArrowLeft') || pressed.has('a') || pressed.has('A');
  const right = pressed.has('ArrowRight') || pressed.has('d') || pressed.has('D');
  if (up && left) return setPos('left-top');
  if (up && right) return setPos('right-top');
  if (down && left) return setPos('left-bottom');
  if (down && right) return setPos('right-bottom');
}
window.addEventListener('keydown', (e)=>{
  const toBlock = ['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' ','Escape'];
  if (toBlock.includes(e.key)) e.preventDefault();
  if (e.key===' ' || e.key==='Escape') { togglePause(); return; }
  pressed.add(e.key);
  if (e.key==='7' || e.code==='Numpad7') return setPos('left-top');
  if (e.key==='9' || e.code==='Numpad9') return setPos('right-top');
  if (e.key==='1' || e.code==='Numpad1') return setPos('left-bottom');
  if (e.key==='3' || e.code==='Numpad3') return setPos('right-bottom');
  updatePosFromKeys();
}, {passive:false});
window.addEventListener('keyup', (e)=>{ pressed.delete(e.key); updatePosFromKeys(); });

// Таблица лидеров
function toggleLeaderboard(){
  const visible = leaderboardBox.style.display !== 'none';
  if (visible) { leaderboardBox.style.display='none'; return; }
  const data = LS.leaderboard();
  leaderboardBox.innerHTML = '<div style="margin-bottom:8px;">Лучшие результаты</div>' + (data.length? '' : '<div style="opacity:.7">Пока пусто. Сыграй партию! 🐺🥚</div>');
  data.forEach((row, i)=>{
    const div = document.createElement('div');
    div.className = 'leaderboard-entry ' + (i===0?'gold':i===1?'silver':i===2?'bronze':'');
    div.innerHTML = `<span>#${i+1}</span><span>${row.name||'YOU'}</span><span>${row.score}</span>`;
    leaderboardBox.appendChild(div);
  });
  leaderboardBox.style.display='block';
}

// Сценарии
function resetState(){
  running = true; paused = false; score = 0; level = 1; lives = 3; combo=0; maxCombo=0; eggsCaught=0; slowUntil=0; multiplierUntil=0;
  entities.forEach(e=>e.remove()); entities = [];
  lastSpawn = 0; spawnInterval = 1100; eggSpeed = 140; hazardLockUntil = 0;
  if (mode==='survival') lives = 1;
  if (mode==='time') { timeLimit = 60_000; timeStart = performance.now(); } else { timeLimit = 0; timeStart = 0; }
  renderLives(); renderScore(); renderCombo(); levelEl.textContent = 1; updateTimeLeft();
  setPos('left-bottom');
}
function startGame(){
  startScreen.style.display = 'none'; gameOver.style.display = 'none'; newRecord.style.display = 'none';
  resetState(); fitHeights(); requestAnimationFrame(tick);
}
function endGame(){
  if (!running) return; running = false; sound.sounds.gameOver();
  const prevBest = LS.best(); if (score > prevBest) { LS.setBest(score); newRecord.style.display='block'; }
  const total = LS.totalEggs() + eggsCaught; LS.setTotalEggs(total);
  const board = LS.leaderboard(); board.push({ name:'YOU', score, ts: Date.now() }); board.sort((a,b)=>b.score-a.score); LS.setLeaderboard(board);
  finalScore.textContent = score; finalBest.textContent = LS.best(); eggsCount.textContent = eggsCaught; maxComboEl.textContent = maxCombo;
  gameOver.style.display = 'flex';
}
function showMenu(){
  bestScoreEl.textContent = LS.best(); totalEggsEl.textContent = LS.totalEggs();
  startScreen.style.display = 'flex'; pauseMenu.style.display = 'none'; gameOver.style.display = 'none';
}
function togglePause(){ if (!running) return; paused = !paused; pauseMenu.style.display = paused ? 'flex' : 'none'; }

// Инициализация
showMenu();
window.addEventListener('touchmove', e=> e.preventDefault(), { passive:false });
fitHeights();
</script>
</body>
</html>
